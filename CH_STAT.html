<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì±„ë„ í†µê³„ ê´€ë¦¬ì ì‹œìŠ¤í…œ</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot,
  query, orderBy, updateDoc, doc,
  deleteDoc, getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ğŸ”¥ Firebase ì„¤ì • */
const firebaseConfig = {
  apiKey: "AIzaSyBpfdrOZh7Jo1nFABHqOhkhl_Id_DYNueU",
  authDomain: "channel-statistics-275ba.firebaseapp.com",
  projectId: "channel-statistics-275ba",
  storageBucket: "channel-statistics-275ba.firebasestorage.app",
  messagingSenderId: "85099988183",
  appId: "1:85099988183:web:fae23a9b13c6fa4de25c92"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let mainTab = "tigerTheater";
let statChannel = "all";
let allData = [];
let unsubscribe = null;

/* =========================
   ë©”ì¸ íƒ­ ì „í™˜
========================= */
window.switchMainTab = function(tab){
  mainTab = tab;

  document.querySelectorAll(".main-tab").forEach(t=>t.classList.remove("active"));
  document.getElementById(tab+"Tab").classList.add("active");

  if(unsubscribe) unsubscribe();

  if(tab==="dbStats"){
    document.getElementById("bulkArea").style.display="none";
    document.getElementById("statTabs").style.display="block";
    loadStats();
  } else {
    document.getElementById("bulkArea").style.display="block";
    document.getElementById("statTabs").style.display="none";
    loadData();
  }
};

/* =========================
   ì¼ë°˜ ë°ì´í„° ë¡œë“œ
========================= */
function loadData(){
  const q = query(collection(db,mainTab), orderBy("no"));
  unsubscribe = onSnapshot(q, snap=>{
    allData = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderTable();
  });
}

/* =========================
   DBí†µê³„ ë°ì´í„° ë¡œë“œ
========================= */
function loadStats(){
  const cols=["tigerTheater","moneyFlow","holeInOne","stockTalk"];
  allData=[];
  cols.forEach(c=>{
    onSnapshot(collection(db,c), snap=>{
      snap.docs.forEach(d=>{
        allData.push({...d.data(), source:c});
      });
      renderStatsTable();
    });
  });
}

/* =========================
   2ì°¨ ì±„ë„ í•„í„°
========================= */
window.switchStatChannel=function(ch){
  statChannel=ch;
  document.querySelectorAll(".stat-tab").forEach(t=>t.classList.remove("active"));
  document.getElementById("stat_"+ch).classList.add("active");
  renderStatsTable();
};

/* =========================
   ì¼ê´„ ì…ë ¥
========================= */
window.bulkInsert = async function(){
  const text=document.getElementById("bulk").value.trim();
  if(!text) return;

  const lines=text.split("\n");
  let startNo=allData.length+1;

  for(let line of lines){
    const c=line.split("\t");

    let data={
      no:startNo++,
      channel:c[1],
      date:c[2],
      time:c[3],
      phone:c[4]||c[5],
      memo:c[5]||c[6],
      manager:c[6]||c[7],
      registered:false,
      memberName:"",
      category:"",
      contractType:"",
      contractAmount:0,
      upsell:false,
      upsellType:"",
      upsellAmount:0
    };

    if(mainTab==="holeInOne")
      data.applicant=c[4];

    await addDoc(collection(db,mainTab),data);
  }

  document.getElementById("bulk").value="";
};

/* =========================
   ì „ì²´ ì‚­ì œ
========================= */
window.deleteAll = async function(){
  if(!confirm("í˜„ì¬ íƒ­ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  const snap=await getDocs(collection(db,mainTab));
  for(const d of snap.docs)
    await deleteDoc(doc(db,mainTab,d.id));
};

/* =========================
   ì…€ ìˆ˜ì • ê¸°ëŠ¥
========================= */
function editable(td, field, id){
  td.ondblclick=function(){
    const old=td.innerText;
    td.innerHTML=`<input value="${old}" style="width:100%">`;
    const input=td.firstChild;
    input.focus();

    input.onblur=async function(){
      let val=input.value;

      if(field==="contractAmount"||field==="upsellAmount")
        val=Number(val.replace(/,/g,""))||0;

      if(field==="registered"||field==="upsell")
        val=(val==="O");

      await updateDoc(doc(db,mainTab,id),{[field]:val});
      td.innerText=(val===true)?"O":(val||"");
    };
  };
}

/* =========================
   í—¤ë” ë Œë”
========================= */
function renderHeader(){
  const thead=document.getElementById("thead");

  if(mainTab==="tigerTheater"){
    thead.innerHTML=`
    <tr>
    <th>ë²ˆí˜¸</th><th>ì±„ë„ëª…</th><th>ë‚ ì§œ</th><th>ì‹œê°„</th>
    <th>íœ´ëŒ€ì „í™”</th><th>ë©”ëª¨</th><th>ë‹´ë‹¹ì</th>
    <th>íšŒì› ë“±ë¡ ì—¬ë¶€</th><th>íšŒì›ëª…</th><th>ë¶„ë¥˜</th>
    <th>ê³„ì•½ë¶„ë¥˜</th><th>ê³„ì•½ ê¸ˆì•¡</th>
    <th>ì—…ì…€ ì „í™˜ ì—¬ë¶€</th><th>ì—…ì…€ ê³„ì•½ë¶„ë¥˜</th><th>ì—…ì…€ ê³„ì•½ ê¸ˆì•¡</th>
    </tr>`;
  }

  if(mainTab==="holeInOne"){
    thead.innerHTML=`
    <tr>
    <th>ë²ˆí˜¸</th><th>ì±„ë„ëª…</th><th>ë‚ ì§œ</th><th>ì‹œê°„</th>
    <th>ì‹ ì²­ì ì„±í•¨</th><th>íœ´ëŒ€ì „í™”</th><th>ë©”ëª¨</th><th>ë‹´ë‹¹ì</th>
    <th>íšŒì› ë“±ë¡ ì—¬ë¶€</th><th>íšŒì›ëª…</th><th>ë¶„ë¥˜</th>
    <th>ê³„ì•½ë¶„ë¥˜</th><th>ê³„ì•½ ê¸ˆì•¡</th>
    <th>ì—…ì…€ ì „í™˜ ì—¬ë¶€</th><th>ì—…ì…€ ê³„ì•½ë¶„ë¥˜</th><th>ì—…ì…€ ê³„ì•½ ê¸ˆì•¡</th>
    </tr>`;
  }

  if(mainTab==="dbStats"){
    thead.innerHTML=`
    <tr>
    <th>ì±„ë„</th><th>ë‚ ì§œ</th><th>ì „í™”ë²ˆí˜¸</th>
    <th>ë“±ë¡</th><th>ê³„ì•½ê¸ˆ</th>
    <th>ì—…ì…€</th><th>ì—…ì…€ê¸ˆ</th>
    </tr>`;
  }
}

/* =========================
   ì¼ë°˜ í…Œì´ë¸” ë Œë”
========================= */
function renderTable(){
  renderHeader();
  const tbody=document.getElementById("tbody");
  tbody.innerHTML="";

  allData.forEach(d=>{
    const row=document.createElement("tr");

    function add(val,field){
      const td=document.createElement("td");
      td.innerText=val||"";
      editable(td,field,d.id);
      row.appendChild(td);
    }

    add(d.no,"no");
    add(d.channel,"channel");
    add(d.date,"date");
    add(d.time,"time");

    if(mainTab==="holeInOne")
      add(d.applicant,"applicant");

    add(d.phone,"phone");
    add(d.memo,"memo");
    add(d.manager,"manager");
    add(d.registered?"O":"","registered");
    add(d.memberName,"memberName");
    add(d.category,"category");
    add(d.contractType,"contractType");
    add((d.contractAmount||0).toLocaleString(),"contractAmount");
    add(d.upsell?"O":"","upsell");
    add(d.upsellType,"upsellType");
    add((d.upsellAmount||0).toLocaleString(),"upsellAmount");

    tbody.appendChild(row);
  });
}

/* =========================
   í†µê³„ í…Œì´ë¸” ë Œë”
========================= */
function renderStatsTable(){
  renderHeader();
  const tbody=document.getElementById("tbody");
  tbody.innerHTML="";

  let data=allData;

  if(statChannel!=="all")
    data=data.filter(d=>d.channel===statChannel);

  data.forEach(d=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
    <td>${d.channel||""}</td>
    <td>${d.date||""}</td>
    <td>${d.phone||""}</td>
    <td>${d.registered?"O":""}</td>
    <td>${(d.contractAmount||0).toLocaleString()}</td>
    <td>${d.upsell?"O":""}</td>
    <td>${(d.upsellAmount||0).toLocaleString()}</td>
    `;
    tbody.appendChild(tr);
  });
}

window.onload=()=>switchMainTab("tigerTheater");

</script>

<style>
body{font-family:sans-serif;padding:30px;background:#f4f6f9;}
.main-tab,.stat-tab{
display:inline-block;padding:10px 15px;margin-right:5px;
border-radius:8px;cursor:pointer;color:white;
}
.main-tab{background:#777;}
.main-tab.active{background:black;}

#statTabs{margin:15px 0;display:none;}
.stat-tab{font-weight:bold;}
#stat_all{background:#333;}
#stat_í˜¸ë‘ì´ê·¹ì¥{background:#e74c3c;}
#stat_ëˆì˜íë¦„{background:#e67e22;}
#stat_ì£¼ì‹í™€ì¸ì›{background:#3498db;}
#stat_ì£¼ì‹í†¡í†¡{background:#2ecc71;}
.stat-tab.active{outline:3px solid #000;}

.card{background:white;padding:20px;margin-bottom:20px;border-radius:10px;}

.table-wrap{overflow-x:auto;}
table{min-width:2000px;border-collapse:collapse;background:white;}
th,td{border:1px solid #ddd;padding:6px;text-align:center;}

textarea{width:100%;height:120px;}
button{padding:6px 12px;margin-top:5px;}
</style>
</head>

<body>

<h1>ì±„ë„ í†µê³„ ê´€ë¦¬ì</h1>

<div>
  <div class="main-tab active" id="tigerTheaterTab" onclick="switchMainTab('tigerTheater')">í˜¸ë‘ì´ê·¹ì¥</div>
  <div class="main-tab" id="holeInOneTab" onclick="switchMainTab('holeInOne')">ì£¼ì‹í™€ì¸ì›</div>
  <div class="main-tab" id="dbStatsTab" onclick="switchMainTab('dbStats')">DBí†µê³„</div>
</div>

<div id="statTabs">
  <div class="stat-tab active" id="stat_all" onclick="switchStatChannel('all')">ëª¨ë‘ë³´ê¸°</div>
  <div class="stat-tab" id="stat_í˜¸ë‘ì´ê·¹ì¥" onclick="switchStatChannel('í˜¸ë‘ì´ê·¹ì¥')">í˜¸ë‘ì´ê·¹ì¥</div>
  <div class="stat-tab" id="stat_ëˆì˜íë¦„" onclick="switchStatChannel('ëˆì˜íë¦„')">ëˆì˜íë¦„</div>
  <div class="stat-tab" id="stat_ì£¼ì‹í™€ì¸ì›" onclick="switchStatChannel('ì£¼ì‹í™€ì¸ì›')">ì£¼ì‹í™€ì¸ì›</div>
  <div class="stat-tab" id="stat_ì£¼ì‹í†¡í†¡" onclick="switchStatChannel('ì£¼ì‹í†¡í†¡')">ì£¼ì‹í†¡í†¡</div>
</div>

<div class="card" id="bulkArea">
  <h3>ì¼ê´„ ë¶™ì—¬ë„£ê¸°</h3>
  <textarea id="bulk"></textarea><br>
  <button onclick="bulkInsert()">ì…ë ¥</button>
  <button onclick="deleteAll()">ì „ì²´ ì‚­ì œ</button>
</div>

<div class="table-wrap">
<table>
<thead id="thead"></thead>
<tbody id="tbody"></tbody>
</table>
</div>

</body>
</html>