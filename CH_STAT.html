<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì±„ë„ í†µê³„ ê´€ë¦¬ì ì‹œìŠ¤í…œ</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, updateDoc,
  deleteDoc, doc, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ğŸ”¥ ë„¤ firebaseConfig ë°˜ì˜ */
const firebaseConfig = {
  apiKey: "AIzaSyBpfdrOZh7Jo1nFABHqOhkhl_Id_DYNueU",
  authDomain: "channel-statistics-275ba.firebaseapp.com",
  projectId: "channel-statistics-275ba",
  storageBucket: "channel-statistics-275ba.firebasestorage.app",
  messagingSenderId: "85099988183",
  appId: "1:85099988183:web:fae23a9b13c6fa4de25c92"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let allData = [];
const colRef = collection(db, "inquiries");

/* ğŸ”¥ ì‹¤ì‹œê°„ ë°ì´í„° ê°ì§€ */
onSnapshot(colRef, snapshot => {
  allData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
  applyFilter();
});

/* ======================
   CRUD
====================== */

window.addData = async function() {
  const data = getFormData();
  await addDoc(colRef, data);
  clearForm();
};

window.editData = function(id) {
  const item = allData.find(d => d.id === id);
  fillForm(item);
};

window.updateData = async function() {
  const id = document.getElementById("docId").value;
  await updateDoc(doc(db,"inquiries",id), getFormData());
  clearForm();
};

window.deleteData = async function(id) {
  if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))
    await deleteDoc(doc(db,"inquiries",id));
};

/* ======================
   í•„í„° & ê²€ìƒ‰
====================== */

window.applyFilter = function() {
  let filtered = [...allData];

  const channel = val("fChannel");
  const manager = val("fManager");
  const category = val("fCategory");
  const contract = val("fContract");
  const upsell = val("fUpsell");
  const keyword = val("search");
  const start = val("fStart");
  const end = val("fEnd");

  if(channel) filtered = filtered.filter(d=>d.channel===channel);
  if(manager) filtered = filtered.filter(d=>d.manager===manager);
  if(category) filtered = filtered.filter(d=>d.category===category);
  if(contract) filtered = filtered.filter(d=>d.contractType===contract);
  if(upsell) filtered = filtered.filter(d=>d.upsellType===upsell);

  if(start) filtered = filtered.filter(d=>d.date>=start);
  if(end) filtered = filtered.filter(d=>d.date<=end);

  if(keyword)
    filtered = filtered.filter(d =>
      (d.phone||"").includes(keyword) ||
      (d.memberName||"").includes(keyword) ||
      (d.memo||"").includes(keyword)
    );

  renderTable(filtered);
  renderStats(filtered);
};

function val(id){ return document.getElementById(id).value; }

/* ======================
   ë Œë”ë§
====================== */

function renderTable(data){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML="";

  data.forEach(d=>{
    tbody.innerHTML+=`
      <tr>
        <td>${d.channel||""}</td>
        <td>${d.date||""}</td>
        <td>${d.manager||""}</td>
        <td>${d.memberName||""}</td>
        <td>${d.contractType||""}</td>
        <td>${num(d.contractAmount)}</td>
        <td>${d.upsellType||""}</td>
        <td>${num(d.upsellAmount)}</td>
        <td>
          <button onclick="editData('${d.id}')">ìˆ˜ì •</button>
          <button onclick="deleteData('${d.id}')">ì‚­ì œ</button>
        </td>
      </tr>`;
  });
}

function renderStats(data){
  const total = data.length;
  const registered = data.filter(d=>d.registered).length;
  const upsell = data.filter(d=>d.upsell).length;
  const sum = data.reduce((s,d)=>s+(d.contractAmount||0),0);
  const upsellSum = data.reduce((s,d)=>s+(d.upsellAmount||0),0);

  const rate = total?((registered/total)*100).toFixed(1):0;
  const upsellRate = registered?((upsell/registered)*100).toFixed(1):0;

  document.getElementById("stats").innerHTML=`
    ì´ DB <b>${total}</b> |
    ë“±ë¡ <b>${registered}</b> (${rate}%) |
    ì—…ì…€ <b>${upsell}</b> (${upsellRate}%) |
    ì‹ ê·œê³„ì•½ <b>${num(sum)}</b> |
    ì—…ì…€ê³„ì•½ <b>${num(upsellSum)}</b>
  `;
}

/* ======================
   í¼ ì²˜ë¦¬
====================== */

function getFormData(){
  return {
    channel: val("channel"),
    date: val("date"),
    manager: val("manager"),
    phone: val("phone"),
    memo: val("memo"),
    registered: document.getElementById("registered").checked,
    memberName: val("memberName"),
    category: val("category"),
    contractType: val("contractType"),
    contractAmount: Number(val("contractAmount"))||0,
    upsell: document.getElementById("upsell").checked,
    upsellType: val("upsellType"),
    upsellAmount: Number(val("upsellAmount"))||0
  };
}

function fillForm(d){
  document.getElementById("docId").value=d.id;
  for(let key in d){
    if(document.getElementById(key)){
      if(typeof d[key]==="boolean")
        document.getElementById(key).checked=d[key];
      else
        document.getElementById(key).value=d[key];
    }
  }
}

function clearForm(){
  document.querySelectorAll("input,select").forEach(e=>{
    if(e.type==="checkbox") e.checked=false;
    else e.value="";
  });
}

function num(n){ return (n||0).toLocaleString()+"ì›"; }

</script>

<style>
body{font-family:sans-serif;background:#f4f6f9;padding:30px;}
.card{background:white;padding:20px;margin-bottom:20px;border-radius:10px;}
table{width:100%;border-collapse:collapse;background:white;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;}
th{background:#f0f0f0;}
input,select{margin:3px;padding:5px;}
button{padding:5px 10px;margin:2px;}
</style>
</head>

<body>

<h1>ì±„ë„ í†µê³„ ê´€ë¦¬ì</h1>

<div class="card" id="stats"></div>

<div class="card">
  ì±„ë„ <input id="fChannel">
  ë‹´ë‹¹ì <input id="fManager">
  ë¶„ë¥˜ <input id="fCategory">
  ê³„ì•½ë¶„ë¥˜ <input id="fContract">
  ì—…ì…€ë¶„ë¥˜ <input id="fUpsell">
  ì‹œì‘ì¼ <input type="date" id="fStart">
  ì¢…ë£Œì¼ <input type="date" id="fEnd">
  ê²€ìƒ‰ <input id="search">
  <button onclick="applyFilter()">í•„í„°</button>
</div>

<div class="card">
  <input type="hidden" id="docId">
  ì±„ë„ <input id="channel">
  ë‚ ì§œ <input type="date" id="date">
  ë‹´ë‹¹ì <input id="manager">
  íœ´ëŒ€ì „í™” <input id="phone">
  ë©”ëª¨ <input id="memo">
  ë“±ë¡ <input type="checkbox" id="registered">
  íšŒì›ëª… <input id="memberName">
  ë¶„ë¥˜ <input id="category">
  ê³„ì•½ë¶„ë¥˜ <input id="contractType">
  ê³„ì•½ê¸ˆ <input id="contractAmount">
  ì—…ì…€ <input type="checkbox" id="upsell">
  ì—…ì…€ë¶„ë¥˜ <input id="upsellType">
  ì—…ì…€ê¸ˆ <input id="upsellAmount">
  <button onclick="addData()">ì¶”ê°€</button>
  <button onclick="updateData()">ìˆ˜ì •ì €ì¥</button>
</div>

<table>
<thead>
<tr>
<th>ì±„ë„</th><th>ë‚ ì§œ</th><th>ë‹´ë‹¹ì</th>
<th>íšŒì›ëª…</th><th>ê³„ì•½ë¶„ë¥˜</th><th>ê³„ì•½ê¸ˆ</th>
<th>ì—…ì…€ë¶„ë¥˜</th><th>ì—…ì…€ê¸ˆ</th><th>ê´€ë¦¬</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</body>
</html>